<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RT Finger Chase — Clinic Dashboard</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
<div class="app" role="application" aria-label="RT Finger Chase Clinic Dashboard">

  <!-- Viewer area at top -->
  <div class="viewer-area">
    <div class="topbar">
      <div>
        <h1> Random Target Touch Test </h1>
        <div class="small-muted"> For patients and clinicians </div>
        <div style="height:8px"></div>
        <!-- Mode toggle -->
        <div class="mode-toggle" role="tablist" aria-label="Choose test mode">
          <button id="modeCursor" class="mode-btn active" role="tab" aria-selected="true">Cursor Test</button>
          <button id="modeCamera" class="mode-btn" role="tab" aria-selected="false">Camera Test (Beta)</button>
        </div>
        <div class="mode-note"><span class="mode-badge" id="modeBadge">Cursor</span> • Toggle to run the camera-based test.</div>
      </div>

      <div class="controls" aria-hidden="false">
        <button id="startBtn" class="primary">Start Test</button>
        <button id="stopBtn">Stop</button>
        <button id="runAgainBtn">Run Again</button>
        <button id="exportBtn">Export CSV</button>
        <button id="resetSettingsBtn">Reset Settings</button>
      </div>
    </div>

    <div class="canvas-wrap panel" id="viewer" aria-live="polite">
      <div class="top-right-info" id="ppcLabel">Pixels/cm: --</div>
      <video id="video" autoplay playsinline style="display:none"></video>
      <canvas id="canvas" role="img" aria-label="Camera feed or Cursor canvas"></canvas>
      <div id="countdownOverlay" class="overlay-countdown" style="display:none"></div>
      <div id="calibSuccessOverlay" class="overlay-success" style="display:none;"></div>

      <!-- Calibration UI (visible in Cursor mode) -->
      <div id="calibUI" class="calib-ui" style="display:none;">
        <div>
          <div class="calib-instr" id="calibInstr">Place a ruler or card (8.5 cm) against the bar to verify length.</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;">
          <div id="calibBar" class="calib-bar" style="width:120px"></div>
          <div style="margin-top:6px;font-size:12px;color:var(--muted)">Green bar = 8.5 cm when measured on your screen. </div>
        </div>
      </div>
    </div>

    <!-- Info and Status stay right under the viewer -->
    <div style="display:flex;gap:12px;margin-top:8px; flex-wrap:wrap;">
      <div class="panel" style="flex:1; min-height:80px;">
        <div class="panel-header"><h2 style="margin:0;font-size:14px">Info</h2></div>
        <div class="panel-body">
          <div class="small-muted">Use the mode toggle to choose Cursor (mouse) or Camera test. Cursor Test runs on a blank canvas — calibrate with ruler for accurate pixels/cm.</div>
        </div>
      </div>
      <div class="panel" style="width:320px; min-height:80px">
        <div class="panel-header"><h2 style="margin:0;font-size:14px">Status</h2></div>
        <div class="panel-body">
          <div id="statusLine">Idle</div>
          <div id="trialLine" class="small-muted" style="margin-top:6px">Trial: -</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom panels: Participant Metadata | Settings | Log -->
  <div class="bottom-panels" role="region" aria-label="Bottom panels: Participant Metadata, Settings, Log">
    <!-- Metadata panel -->
    <div class="panel" id="metaPanel">
      <div class="panel-header">
        <div>
          <h2 class="meta-title">Participant Metadata</h2>
          <div class="small-muted" style="margin-top:4px">Large label for clarity</div>
        </div>
        <div class="header-actions">
          <button id="saveMetaBtn">Save Metadata</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="meta-grid">
          <div>
            <label>Participant ID *</label>
            <input id="meta_participant" type="text" placeholder="e.g. P001" />
          </div>
          <div>
            <label>Session ID</label>
            <input id="meta_session" type="text" placeholder="e.g. S1" />
          </div>
          <div>
            <label>Date</label>
            <input id="meta_date" type="date" />
          </div>
          <div>
            <label>Hand *</label>
            <select id="meta_hand">
              <option value="">Select</option>
              <option value="R">Right</option>
              <option value="L">Left</option>
            </select>
          </div>
          <div style="grid-column:1/3">
            <label>Notes</label>
            <textarea id="meta_notes" rows="3" placeholder="Optional notes..."></textarea>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <div class="small-muted">Saved to device</div>
        </div>
      </div>
    </div>

    <!-- Settings panel -->
    <div class="panel" id="settingsPanel" style="margin-top:0">
      <div class="panel-header">
        <div>
          <h2 class="settings-title">Settings</h2>
          <div class="small-muted" style="margin-top:4px">Core test parameters</div>
        </div>
        <div class="header-actions">
          <button id="saveSettingsBtn">Save Settings</button>
        </div>
      </div>

      <div class="panel-body">
        <div class="col">
          <div class="row">
            <div style="flex:1">
              <label>Targets</label>
              <input id="cfg_targets" type="number" value="5" min="1" />
            </div>
            <div style="width:120px">
              <label>Target interval (s)</label>
              <input id="cfg_interval" type="number" value="2.0" step="0.1" min="0.1" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Target radius (cm)</label>
              <input id="cfg_radius_cm" type="number" value="5.0" step="0.1" />
            </div>
            <div style="width:120px">
              <label>Edge width (px)</label>
              <input id="cfg_edge_px" type="number" value="5" />
            </div>
          </div>

          <div class="row">
            <div style="flex:1">
              <label>Minimum distance between targets (cm)</label>
              <input id="cfg_min_distance_cm" type="number" value="10" step="0.1" />
            </div>
            <div style="width:120px">
              <label>Center dot (1 cm)</label>
              <select id="cfg_center_dot"><option value="1">Yes</option><option value="0">No</option></select>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div style="flex:1">
              <label>Trail animation between targets</label>
              <select id="cfg_trail"><option value="1">Yes</option><option value="0">No</option></select>
            </div>
            <div style="width:140px">
              <label>Countdown / Sound cue</label>
              <select id="cfg_countdown"><option value="0">Off</option><option value="1">On</option></select>
            </div>
          </div>

          <!-- Editable Pixels per cm + single Calibrate button -->
          <div class="row" style="margin-top:10px;align-items:center">
            <div style="flex:1">
              <label>Pixels / cm (default)</label>
              <input id="cfg_ppc" type="number" step="0.1" value="30.0" />
              <div class="small-muted" style="margin-top:6px">Set a default pixels-per-cm or press Calibrate to automatically measure index-finger length (camera) or estimate from monitor.</div>
            </div>
            <div style="width:140px">
              <label>&nbsp;</label>
              <button id="calibrateBtn" style="width:100%">Calibrate</button>
            </div>
          </div>
          
          <div class="row" style="margin-top:8px">
            <div style="flex:1">
                <label>Finger length for calibration (cm)</label>
                <input id="cfg_finger_cm" type="number" step="0.1" value="7.5" />
                <div class="small-muted" style="margin-top:6px">Used to compute pixels/cm during automatic calibration.</div>
            </div>
          </div>


          <!-- Monitor size selection for Cursor Test -->
          <div style="margin-top:10px">
            <label>Monitor size (diagonal)</label>
            <div class="monitor-row">
              <select id="monitorSize">
                <option value="15.6">15.6"</option>
                <option value="24">24"</option>
                <option value="27">27"</option>
                <option value="custom">Custom</option>
              </select>
              <input id="monitorCustom" type="number" step="0.1" placeholder="Inches (if custom)" style="display:none" />
              <button id="estimatePpcBtn">Estimate ppc</button>
            </div>
            <div class="small-muted" style="margin-top:8px">Estimating pixels/cm from monitor diagonal and screen CSS width. Verify with the green bar in Cursor Test.</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;">
            <button id="applySettingsBtnLite">Apply (temporary)</button>
            <button id="resetSettingsBtnLocal">Reset</button>
          </div>
          <div class="small-muted" style="margin-top:8px">Settings are saved to this device and restored next time.</div>
        </div>
      </div>
    </div>

    <!-- Log panel -->
    <div class="panel" id="logPanel">
      <div class="panel-header log-header">
        <div>
          <h2 style="margin:0;font-size:15px">Log</h2>
          <div class="small-muted" style="margin-top:4px">Activity & result summary</div>
        </div>
        <div class="header-actions">
          <button id="clearLogBtn">Clear Log</button>
        </div>
      </div>

      <div class="panel-body" style="display:flex;flex-direction:column;padding:0;">
        <div id="logArea" class="log" role="log" aria-live="polite" style="border-radius:0;"></div>
      </div>
    </div>

  </div>

</div>

<!-- MediaPipe (must be loaded before app.js) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<!-- App script -->
<script src="app.js"></script>
</body>
</html>
